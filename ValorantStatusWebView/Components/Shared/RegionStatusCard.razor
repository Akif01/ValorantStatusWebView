@using System.Timers
@using ValorantStatusWebView.API
@using ValorantStatusWebView.DataTransferObjects
@using ValorantStatusWebView.Models
@using Microsoft.AspNetCore.Components
@inject ApiService Service
@implements IDisposable
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="card" style="width: 18rem;">
    <div class="card-body">
        @if (HasError)
        {
            <h5 class="card-title">Loading failed!</h5>
            <p class="card-text text-danger">@_errorMessage</p>
        }
        else if (_currentModel is null)
        {
            <h5 class="card-title">Loading...</h5>
            <div class="spinner-border" role="status"></div>
        }
        else
        {
            <h5 class="card-title">@_currentModel.RegionName</h5>
            <p class="card-text text-@(_currentModel.IsAvailable ? "success" : "danger")">
                @(_currentModel.IsAvailable ? "Available" : "Not Available")
            </p>
            <small class="text-muted">Last updated: @_lastUpdated.ToString("g")</small>
        }
    </div>
</div>

@code {
    public enum Regions
    {
        ap,
        br,
        eu,
        kr,
        latam,
        na
    }

    [Parameter, EditorRequired]
    public required Regions Region { get; set; }

    [Parameter]
    public int RefreshIntervalSeconds { get; set; } = 30;

    private PlatformModel? _currentModel;
    private System.Timers.Timer? _timer;
    private string? _errorMessage;
    private DateTime _lastUpdated = DateTime.Now;
    private bool HasError => !string.IsNullOrEmpty(_errorMessage);
    private bool _isDisposed;

    protected override async Task OnInitializedAsync()
    {
        await UpdateModelAsync();

        _timer = new System.Timers.Timer(RefreshIntervalSeconds * 1000);
        _timer.Elapsed += OnTimerElapsed;
        _timer.AutoReset = true;
        _timer.Start();
    }

    private async void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        if (_isDisposed)
            return;

        await UpdateModelAsync();
    }

    private async Task UpdateModelAsync()
    {
        try
        {
            var newModel = await FetchModelAsync(Region);
            if (newModel is not null && (_currentModel is null || !newModel.Equals(_currentModel)))
            {
                _currentModel = newModel;
                _lastUpdated = DateTime.Now;

                if (!_isDisposed)
                {
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;

            if (!_isDisposed)
            {
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task<PlatformModel?> FetchModelAsync(Regions region)
    {
        try
        {
            _errorMessage = null;
            return await Service.GetPlatformModelAsync(region);
        }
        catch (HttpRequestException httpRequestException)
        {
            _errorMessage = httpRequestException.Message;
            return null;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unexpected error: {ex.Message}";
            return null;
        }
    }

    public void Dispose()
    {
        _isDisposed = true;

        if (_timer != null)
        {
            _timer.Elapsed -= OnTimerElapsed;
            _timer.Stop();
            _timer.Dispose();
            _timer = null;
        }
    }
}